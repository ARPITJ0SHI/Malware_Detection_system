import pefile
import os
import array
import math
import pickle
import sys
import argparse
import joblib
from sklearn.ensemble import RandomForestClassifier

from File import File
from Classifier import Classifier
from Data import Data
from notification import Notification
from checkFile import checkFile
import os

import time

if __name__ == '__main__':
	
    c = Classifier()
    d = Data()
    n = Notification()
    initial = os.listdir()
    first = True

    extentions = ['.acm', '.ax', '.cpl', '.dll','.exe', '.drv', '.efi', '.mui', '.ocx', '.scr', '.sys', '.tsp']

    while True:
        if first:
            for file in initial:
                f = checkFile(file)
                if f == 0:
                    n.notifyFile(file)
                if file[-4:] in extentions:
                    print(file)
                    f = File(file, file)
                    try:
                        fileData = f.extract_infos()
                    except Exception as e:
                        time.sleep(3)
                        fileData = f.extract_infos()
                    res = d.data(fileData)

                    result = c.predict(res)
                    n.notify(result, file)

                    print ('The file %s is %s' % (file,['malicious', 'legitimate'][result]))
            first = False
        
        else:
            new = os.listdir()
            difference = []
            if new != initial:
                s = set(initial)
                difference = [x for x in new if x not in s]

            for file in difference:
                f = checkFile(file)
                if f == 0:
                    n.notifyFile(file)
                if file[-4:] in extentions:
                    f = File(file, file)
                    try:
                        fileData = f.extract_infos()
                    except Exception as e:
                        time.sleep(3)
                        fileData = f.extract_infos()
                    res = d.data(fileData)
                    result = c.predict(res)
                    n.notify(result, file)
                    print ('The file %s is %s' % (file,['malicious', 'legitimate'][result]))

            initial = new
        time.sleep(1)
